<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha Administrativa - La Abuela Ana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @media print {
            @page { size: A4; margin: 10mm; }
            .no-print { display: none !important; }
            body { background: white !important; font-family: sans-serif; }
            #ficha-impresion { display: block !important; }
            .print-header-black { 
                background-color: #1e293b !important; 
                color: white !important; 
                padding: 8px 15px; font-size: 11px; font-weight: 900; 
                text-transform: uppercase; margin-top: 15px; -webkit-print-color-adjust: exact;
            }
            .print-table { width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 5px; }
            .print-table td { border: 1px solid #000; padding: 10px; font-size: 10px; }
            .print-label { background-color: #f1f5f9 !important; font-weight: bold; width: 25%; font-size: 8px; }
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #ficha-impresion { display: none; } 
        
        /* Estilos mejorados minimalistas */
        .card-elevated { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04), 0 1px 3px rgba(0, 0, 0, 0.04); 
            border: 1px solid #f1f5f9;
            transition: all 0.2s ease;
        }
        .card-elevated:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06), 0 2px 6px rgba(0, 0, 0, 0.04);
        }
        
        /* T√≠tulos claros */
        .section-title {
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f8fafc;
            padding-bottom: 0.5rem;
        }
        
        /* Badge moderno */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 0.05em;
        }
        
        /* Inputs modernos */
        .input-modern {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .input-modern:focus {
            outline: none;
            border-color: #ef4444;
            background: white;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        
        /* Botones mejorados */
        .btn-primary {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-radius: 12px;
            padding: 0.875rem 1.5rem;
            font-weight: 700;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.25);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        
        /* Modal mejorado */
        .modal-overlay { 
            background: rgba(0,0,0,0.5); 
            backdrop-filter: blur(8px); 
        }
        
        /* Tabla mejorada */
        .table-modern {
            width: 100%;
            font-size: 0.8rem;
        }
        .table-modern thead {
            border-bottom: 2px solid #f1f5f9;
        }
        .table-modern th {
            padding: 0.75rem 1rem;
            font-weight: 700;
            color: #64748b;
            text-align: left;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
        }
        .table-modern td {
            padding: 1rem;
            border-bottom: 1px solid #f8fafc;
            color: #475569;
            font-weight: 500;
        }
        .table-modern tbody tr:hover {
            background: #f8fafc;
        }
        
        /* Layout mejorado */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr 2fr;
            }
        }
        
        /* Value display */
        .value-display {
            font-size: 2rem;
            font-weight: 800;
            color: #0f172a;
            line-height: 1;
        }
        .value-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Menu item */
        .menu-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #ef4444;
            transition: all 0.2s;
        }
        .menu-item:hover {
            background: #f1f5f9;
            transform: translateX(2px);
        }
        
        /* Pagos historial */
        .pago-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            border: 1px solid #f1f5f9;
            margin-bottom: 0.5rem;
        }
        .pago-item:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen" onload="cargarFichaAdministrativa()">

    <!-- Header minimalista -->
    <header class="sticky top-0 z-50 no-print bg-white border-b border-slate-100 px-6 py-4">
        <div class="max-w-[1600px] mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-red-600 to-red-700 flex items-center justify-center">
                    <i data-lucide="clipboard-list" class="w-5 h-5 text-white"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-900">Ficha Administrativa</h1>
                    <p id="header-cliente" class="text-xs font-semibold text-slate-500">Cargando cliente...</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="imprimirFicha()" class="btn-primary">
                    <i data-lucide="printer" class="w-4 h-4"></i>
                    Generar Ficha
                </button>
                <button onclick="location.href='admin.html'" class="text-sm font-medium text-slate-600 hover:text-red-600 transition-colors px-4 py-2 rounded-lg hover:bg-slate-50">
                    Cerrar
                </button>
            </div>
        </div>
    </header>

    <!-- Contenido principal -->
    <main class="max-w-[1600px] mx-auto p-6 no-print">
        <div class="dashboard-grid">
            
            <!-- Columna izquierda -->
            <div class="space-y-6">
                <!-- Panel de contabilidad -->
                <div class="card-elevated p-6">
                    <h2 class="text-lg font-bold text-slate-900 mb-6 flex items-center gap-2">
                        <i data-lucide="wallet" class="w-5 h-5 text-red-600"></i>
                        Estado Financiero
                    </h2>
                    
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="p-4 bg-gradient-to-br from-red-50 to-red-50/50 rounded-xl border border-red-100">
                            <p class="value-label">Contratado</p>
                            <p id="txt-total-u" class="value-display">0.0 u.</p>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-emerald-50 to-emerald-50/50 rounded-xl border border-emerald-100">
                            <p class="value-label">Congelado</p>
                            <p id="txt-pagas-u" class="value-display text-emerald-700">0.0 u.</p>
                        </div>
                    </div>
                    
                    <div class="p-6 bg-slate-50 rounded-xl mb-6">
                        <p class="value-label mb-2">Saldo Pendiente</p>
                        <h2 id="txt-saldo-pesos" class="value-display text-slate-900">$ 0</h2>
                    </div>
                    
                    <button onclick="registrarPago()" class="btn-primary w-full">
                        <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                        Registrar Pago
                    </button>
                </div>

                <!-- Servicios adicionales -->
                <div class="card-elevated p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-slate-900">Servicios Adicionales</h2>
                        <button onclick="abrirModalAdicional()" class="w-9 h-9 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 flex items-center justify-center transition-colors">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto rounded-lg border border-slate-100">
                        <table class="table-modern">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th class="text-center">Cant.</th>
                                    <th class="text-right">Precio</th>
                                    <th class="text-right text-pink-600">Pagado</th>
                                </tr>
                            </thead>
                            <tbody id="grid-adicionales"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Notas -->
                <div class="card-elevated p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                            <i data-lucide="edit-3" class="w-5 h-5 text-red-600"></i>
                            Notas del Evento
                        </h2>
                        <button onclick="guardarNotas()" class="text-sm font-medium bg-slate-100 text-slate-700 hover:bg-red-600 hover:text-white px-3 py-1.5 rounded-lg transition-colors">
                            Guardar
                        </button>
                    </div>
                    <textarea id="txt-notas" rows="4" class="input-modern w-full" placeholder="Agregar notas importantes sobre el evento..."></textarea>
                </div>
            </div>

            <!-- Columna derecha -->
            <div class="space-y-6">
                <!-- Primera fila: Historial y Detalles -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Historial de pagos -->
                    <div class="card-elevated p-6">
                        <h3 class="section-title">Historial de Entregas</h3>
                        <div id="lista-pagos" class="space-y-3 max-h-[320px] overflow-y-auto pr-2"></div>
                    </div>

                    <!-- Detalles log√≠sticos -->
                    <div class="card-elevated p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-lg font-bold text-slate-900">Detalles del Evento</h2>
                            <span id="badge-tipo" class="badge bg-pink-100 text-pink-700">---</span>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-3 bg-slate-50 rounded-lg">
                                    <p class="value-label">Fecha</p>
                                    <p id="txt-log-fecha" class="font-semibold text-slate-800">---</p>
                                </div>
                                <div class="p-3 bg-slate-50 rounded-lg">
                                    <p class="value-label">Sal√≥n</p>
                                    <p id="txt-log-salon" class="font-semibold text-slate-800">---</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-3 bg-slate-50 rounded-lg">
                                    <p class="value-label">Vendedor</p>
                                    <p id="txt-log-vendedor" class="font-semibold text-slate-800">---</p>
                                </div>
                                <div class="p-3 bg-slate-50 rounded-lg">
                                    <p class="value-label">Pax Totales</p>
                                    <p id="txt-log-pax" class="font-semibold text-slate-800">0.0 u.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Men√∫ diagramado -->
                <div class="card-elevated p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-slate-900">Men√∫ Seleccionado</h2>
                        <button onclick="window.location.href='ficha.html?dni=' + dni" class="text-sm font-medium text-red-600 hover:text-red-700 flex items-center gap-2">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                            Modificar
                        </button>
                    </div>
                    
                    <div id="grid-menu-elegido" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal adicionales -->
    <div id="modal-adicional" class="fixed inset-0 modal-overlay z-[100] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl p-8 shadow-2xl">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 rounded-lg bg-red-50 flex items-center justify-center">
                    <i data-lucide="plus-circle" class="w-5 h-5 text-red-600"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-slate-900">Nuevo Servicio Adicional</h2>
                    <p class="text-sm text-slate-500">Complete los detalles del servicio</p>
                </div>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Concepto</label>
                    <input type="text" id="add-concepto" placeholder="Ej: Servicio de DJ, Fotograf√≠a, etc." 
                           class="input-modern w-full">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Cantidad</label>
                        <input type="number" id="add-cant" value="1" min="1" 
                               class="input-modern w-full text-center">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Precio Unitario ($)</label>
                        <input type="number" id="add-precio" value="0" min="0" 
                               class="input-modern w-full text-center">
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3 mt-8">
                <button onclick="cerrarModalAdicional()" 
                        class="flex-1 py-3 px-4 rounded-lg border border-slate-200 text-slate-700 font-medium hover:bg-slate-50 transition-colors">
                    Cancelar
                </button>
                <button onclick="guardarAdicional()" 
                        class="flex-1 btn-primary">
                    <i data-lucide="check" class="w-4 h-4"></i>
                    Guardar Servicio
                </button>
            </div>
        </div>
    </div>

    <!-- Ficha para impresi√≥n -->
    <div id="ficha-impresion" class="p-10">
        <div class="flex justify-between border-b-4 border-black pb-4 mb-6 text-black">
            <div><h1 class="text-3xl font-black uppercase">Ficha Maestra de Evento</h1><p class="text-xs font-bold uppercase">La Abuela Ana - Operaciones</p></div>
            <div class="text-right font-bold text-xs uppercase" id="p-hoy"></div>
        </div>
        <div class="print-header-black">Log√≠stica y Cliente</div>
        <table class="print-table">
            <tr><td class="print-label">Titular</td><td id="p-nombre" class="font-bold"></td><td class="print-label">DNI</td><td id="p-dni"></td></tr>
            <tr><td class="print-label">Evento</td><td id="p-tipo"></td><td class="print-label">Fecha</td><td id="p-fecha" class="font-bold text-red-700"></td></tr>
            <tr><td class="print-label">Lugar</td><td id="p-lugar"></td><td class="print-label">Pax</td><td id="p-pax" class="font-bold"></td></tr>
        </table>
        <div class="print-header-black">Notas Especiales</div>
        <div id="p-notas-print" class="print-content-box italic uppercase font-bold text-gray-600"></div>
        <div class="print-header-black">Men√∫ Seleccionado</div>
        <div id="p-menu-print" class="print-content-box grid grid-cols-2 gap-2 uppercase font-bold text-[9px]"></div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const dni = urlParams.get('dni');
        window.currentEventData = null;

        // üîπ CONFIGURACI√ìN RIVERS DATA
        // Reemplaza 'TU_IP_PUBLICA' con la IP real de tu VPS de DigitalOcean
        const API_URL = 'http://TU_IP_PUBLICA:5000';

        async function cargarFichaAdministrativa() {
            lucide.createIcons();
            if(!dni) return;
            try {
                // Conexi√≥n al servidor en DigitalOcean para obtener la ficha completa
                const res = await fetch(`${API_URL}/api/evento/ficha_completa/${dni}`);
                const data = await res.json();
                window.currentEventData = data;

                // Inyecci√≥n de datos en la interfaz web
                document.getElementById('header-cliente').innerText = data.nombre_cliente;
                document.getElementById('badge-tipo').innerText = data.tipo_evento || 'Evento';
                document.getElementById('txt-log-fecha').innerText = data.fecha_iso;
                document.getElementById('txt-log-salon').innerText = data.salon || '---';
                document.getElementById('txt-log-vendedor').innerText = data.vendedor || '---';
                document.getElementById('txt-notas').value = data.notas_evento || '';

                // C√°lculos Financieros
                const contratadas = parseFloat(data.total_cubiertos_contratados) || 0;
                const pagadoPesos = parseFloat(data.total_abonado_pesos) || 0;
                const unidadesPagas = parseFloat(data.unidades_pagas) || 0;
                const valorCubierto = parseFloat(data.valor_cubierto_actual) || 0;
                const montoTotalContrato = Math.round(contratadas * valorCubierto * 1.21);
                const saldoReal = Math.max(0, montoTotalContrato - pagadoPesos);

                document.getElementById('txt-total-u').innerText = contratadas.toFixed(1) + ' u.';
                document.getElementById('txt-pagas-u').innerText = unidadesPagas.toFixed(1) + ' u.';
                document.getElementById('txt-log-pax').innerText = contratadas.toFixed(1) + ' u.';
                document.getElementById('txt-saldo-pesos').innerText = '$ ' + saldoReal.toLocaleString('es-AR');

                // Renderizado de Historial, Men√∫ y Adicionales
                document.getElementById('lista-pagos').innerHTML = data.historial_pagos.map(p => `
                    <div class="pago-item">
                        <div>
                            <p class="value-label">${p.fecha_pago}</p>
                            <p class="text-base font-bold text-slate-800">$ ${Math.round(p.monto_dinero).toLocaleString()}</p>
                        </div>
                        <span class="text-xs font-semibold text-slate-500 uppercase">Adelanto</span>
                    </div>`).join('');

                document.getElementById('grid-menu-elegido').innerHTML = data.menu_elegido.map(m => `
                    <div class="menu-item">
                        <div class="w-8 h-8 rounded-lg bg-red-50 flex items-center justify-center mr-3">
                            <i data-lucide="utensils" class="w-4 h-4 text-red-600"></i>
                        </div>
                        <div class="overflow-hidden">
                            <p class="text-xs font-semibold text-slate-500 uppercase">${m.categoria}</p>
                            <p class="text-sm font-medium text-slate-800 truncate">${m.nombre_plato}</p>
                        </div>
                    </div>`).join('');

                document.getElementById('grid-adicionales').innerHTML = data.lista_adicionales.map(a => `
                    <tr>
                        <td class="font-medium text-slate-800">${a.concepto}</td>
                        <td class="text-center font-semibold">${a.cantidad}</td>
                        <td class="text-right font-medium">$ ${Math.round(a.precio_unitario).toLocaleString()}</td>
                        <td class="text-right font-bold text-pink-600">$ ${Math.round(a.pago_realizado).toLocaleString()}</td>
                    </tr>`).join('');

                lucide.createIcons();
            } catch (err) { 
                console.error("Error cr√≠tico en DigitalOcean:", err);
                alert("No se pudo conectar con el servidor Rivers Data en la nube.");
            }
        }

        async function guardarAdicional() {
            const concepto = document.getElementById('add-concepto').value.trim();
            const cantidad = document.getElementById('add-cant').value;
            const precio = document.getElementById('add-precio').value;

            if (!concepto) return alert('Ingrese un concepto v√°lido.');

            const payload = { dni: dni, concepto: concepto, cantidad: cantidad, precio: precio };
            
            try {
                const res = await fetch(`${API_URL}/api/evento/adicional/nuevo`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                if(res.ok) {
                    cerrarModalAdicional();
                    location.reload();
                }
            } catch (err) { console.error('Error:', err); }
        }

        async function guardarNotas() {
            const notas = document.getElementById('txt-notas').value;
            try {
                const res = await fetch(`${API_URL}/api/evento/actualizar_notas`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ dni: dni, notas: notas })
                });
                if(res.ok) {
                    const btn = document.querySelector('[onclick="guardarNotas()"]');
                    btn.textContent = '‚úì Guardado';
                    setTimeout(() => { btn.textContent = 'Guardar'; }, 2000);
                }
            } catch (err) { console.error('Error:', err); }
        }

        async function registrarPago() {
            const monto = prompt("Ingrese el monto entregado ($):");
            if (!monto || isNaN(monto)) return;
            
            try {
                const res = await fetch(`${API_URL}/api/evento/registrar_pago`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ dni: dni, monto: parseFloat(monto) })
                });
                if (res.ok) location.reload();
            } catch (err) { console.error('Error:', err); }
        }

        function imprimirFicha() {
            const data = window.currentEventData;
            if(!data) return;
            document.getElementById('p-hoy').innerText = "EMISI√ìN: " + new Date().toLocaleDateString();
            document.getElementById('p-nombre').innerText = data.nombre_cliente;
            document.getElementById('p-dni').innerText = data.dni_cliente;
            document.getElementById('p-tipo').innerText = data.tipo_evento;
            document.getElementById('p-fecha').innerText = data.fecha_iso;
            document.getElementById('p-lugar').innerText = data.salon;
            document.getElementById('p-pax').innerText = parseFloat(data.total_cubiertos_contratados).toFixed(1) + " U.";
            
            const total = Math.round(parseFloat(data.total_cubiertos_contratados) * parseFloat(data.valor_cubierto_actual) * 1.21);
            const pagado = parseFloat(data.total_abonado_pesos);
            document.getElementById('p-saldo').innerText = "$ " + (total - pagado).toLocaleString('es-AR');
            document.getElementById('p-notas-print').innerText = document.getElementById('txt-notas').value;
            document.getElementById('p-menu-print').innerHTML = data.menu_elegido.map(m => `<div>${m.categoria}: ${m.nombre_plato}</div>`).join('');
            
            window.print();
        }

        function abrirModalAdicional() { document.getElementById('modal-adicional').classList.replace('hidden', 'flex'); }
        function cerrarModalAdicional() { document.getElementById('modal-adicional').classList.replace('flex', 'hidden'); }
    </script>
</body>
</html>